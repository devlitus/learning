---
import Button from "../../components/button/Button.astro";
import Input from "../../components/input/Input.astro";
import Label from "../../components/label/Label.astro";
import AuthLayout from "../../layouts/AuthLayout.astro";
import { authenticateUser, isAuthenticated } from "../../utils/ssrAuthUtils";
import type { AuthCredential } from "../../schema/authCredential.schema";

// Variables para manejar el estado de la página
let errorMessage = "";
let formData: { email: string; password: string; remember: boolean } = {
  email: "",
  password: "",
  remember: false,
};

// Verificar si ya está autenticado y redirigir
if (isAuthenticated(Astro.cookies)) {
  return Astro.redirect("/onboarding/level");
}

// Manejar envío del formulario (SSR)
if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    const email = data.get("email") as string;
    const password = data.get("password") as string;
    const remember = data.get("remember") === "on";

    // Guardar datos del formulario para mantener el estado en caso de error
    formData = { email, password, remember };

    // Validar que los campos requeridos estén presentes
    if (!email || !password) {
      errorMessage = "Por favor, completa todos los campos";
    } else {
      // Intentar autenticar
      const credentials: AuthCredential = { email, password };
      const result = await authenticateUser(credentials, Astro.cookies);

      if (result.success && result.user) {
        // Si se marcó "recordarme", extender la cookie
        if (remember) {
          Astro.cookies.set("auth-user", JSON.stringify(result.user), {
            path: "/",
            maxAge: 60 * 60 * 24 * 90, // 90 días
            httpOnly: false,
            secure: false,
            sameSite: "lax",
          });
        }

        // Redirigir al onboarding
        return Astro.redirect("/onboarding/level");
      } else {
        errorMessage = result.error || "Error al iniciar sesión";
      }
    }
  } catch (error) {
    console.error("Login error:", error);
    errorMessage = "Error del servidor. Intenta nuevamente.";
  }
}
---

<AuthLayout>
  <div class="w-full max-w-md">
    <!-- Logo/Título -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Iniciar Sesión</h1>
      <p class="text-gray-600">Ingresa a tu cuenta</p>
    </div>

    <!-- Formulario -->
    <div class="bg-white rounded-2xl shadow-xl p-8">
      <form method="POST" class="space-y-6">
        <!-- Mensaje de error -->
        {
          errorMessage && (
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
              <p>{errorMessage}</p>
            </div>
          )
        }

        <!-- Campo Email -->
        <div class="space-y-2">
          <Label for="email" class="text-gray-700 font-medium">Email</Label>
          <Input
            type="email"
            id="email"
            name="email"
            value={formData.email}
            required
            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 placeholder-gray-400"
            placeholder="Ingresa tu email"
          />
        </div>

        <!-- Campo Contraseña -->
        <div class="space-y-2">
          <Label for="password" class="text-gray-700 font-medium"
            >Contraseña</Label
          >
          <Input
            type="password"
            id="password"
            name="password"
            value={formData.password}
            required
            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200 placeholder-gray-400"
            placeholder="Ingresa tu contraseña"
          />
        </div>

        <!-- Opciones adicionales -->
        <div class="flex items-center justify-between text-sm">
          <label class="flex items-center space-x-2 text-gray-600">
            <input
              type="checkbox"
              name="remember"
              checked={formData.remember}
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            />
            <span>Recordarme</span>
          </label>
          <a
            href="#"
            class="text-blue-600 hover:text-blue-800 transition-colors"
          >
            ¿Olvidaste tu contraseña?
          </a>
        </div>

        <!-- Botón de Login -->
        <Button
          type="submit"
          class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transform hover:scale-[1.02] transition-all duration-200"
        >
          Iniciar Sesión
        </Button>
      </form>

      <!-- Divider -->
      <div class="my-6 flex items-center">
        <div class="flex-1 border-t border-gray-200"></div>
        <span class="px-4 text-gray-500 text-sm">o</span>
        <div class="flex-1 border-t border-gray-200"></div>
      </div>

      <!-- Registro -->
      <div class="text-center">
        <p class="text-gray-600">
          ¿No tienes cuenta?
          <a
            href="/auth/register"
            class="text-blue-600 hover:text-blue-800 font-medium transition-colors"
          >
            Regístrate aquí
          </a>
        </p>
      </div>
    </div>

    <!-- Información de prueba -->
    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
      <h3 class="text-sm font-semibold text-blue-900 mb-2">
        🧪 Credenciales de prueba:
      </h3>
      <div class="text-xs text-blue-800 space-y-1">
        <p><strong>Email:</strong> admin@example.com</p>
        <p><strong>Contraseña:</strong> password123</p>
        <p class="text-blue-600 mt-2">O usa: user@example.com / password123</p>
      </div>
    </div>
  </div>
</AuthLayout>
