---
import AuthLayout from "../layouts/AuthLayout.astro";
import Button from "../components/button/Button.astro";
import Input from "../components/input/Input.astro";
import Label from "../components/label/Label.astro";
import { getSupabaseTokens } from "../utils/ssrAuthUtils";

const { cookies, redirect } = Astro;

// Verificar si ya est√° autenticado
const { accessToken, refreshToken } = getSupabaseTokens(cookies);

if (accessToken && refreshToken) {
  return redirect("/onboarding/level");
}

// Manejo de errores desde la URL
const error = Astro.url.searchParams.get("error");
const message = Astro.url.searchParams.get("message");
---

<AuthLayout>
  <div class="w-full max-w-md mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="text-4xl mb-4">üîê</div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        ¬°Bienvenido de vuelta!
      </h1>
      <p class="text-gray-600">
        Inicia sesi√≥n en tu cuenta para continuar aprendiendo
      </p>
    </div>

    <!-- Mensajes de error/√©xito -->
    {
      error && (
        <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-center">
            <div class="text-red-600 mr-2">‚ö†Ô∏è</div>
            <p class="text-red-800">{error}</p>
          </div>
        </div>
      )
    }

    {
      message && (
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center">
            <div class="text-blue-600 mr-2">‚ÑπÔ∏è</div>
            <p class="text-blue-800">{message}</p>
          </div>
        </div>
      )
    }

    <!-- Formulario de inicio de sesi√≥n -->
    <form action="/auth/signin" method="post" class="space-y-6">
      <div>
        <Label for="email">Correo electr√≥nico</Label>
        <input
          type="email"
          name="email"
          id="email"
          required
          placeholder="tu@email.com"
          autocomplete="email"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
        />
      </div>

      <div>
        <Label for="password">Contrase√±a</Label>
        <input
          type="password"
          name="password"
          id="password"
          required
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          autocomplete="current-password"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
        />
      </div>

      <!-- Bot√≥n de env√≠o -->
      <Button
        type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        Iniciar sesi√≥n
      </Button>
    </form>

    <!-- Enlaces adicionales -->
    <div class="mt-6 text-center space-y-4">
      <p class="text-gray-600">
        ¬øNo tienes una cuenta?
        <a
          href="/register"
          class="text-blue-600 hover:text-blue-700 font-semibold transition-colors"
        >
          Reg√≠strate aqu√≠
        </a>
      </p>

      <div class="text-sm text-gray-500">
        <p>¬øOlvidaste tu contrase√±a?</p>
        <a
          href="/auth/forgot-password"
          class="text-blue-600 hover:text-blue-700 transition-colors"
        >
          Recuperar contrase√±a
        </a>
      </div>
    </div>

    <!-- Informaci√≥n de prueba (solo para desarrollo) -->
    <div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
      <h3 class="font-semibold text-blue-900 mb-2">üöÄ ¬øPrimera vez aqu√≠?</h3>
      <p class="text-sm text-blue-800 mb-3">Si no tienes una cuenta, puedes:</p>
      <div class="space-y-2">
        <a
          href="/register"
          class="inline-flex items-center bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
        >
          ‚ú® Crear una cuenta nueva
        </a>
        <p class="text-xs text-blue-700">
          Solo toma 30 segundos y puedes empezar a aprender inmediatamente.
        </p>
      </div>
    </div>
  </div>

  <!-- Scripts para mejorar la experiencia -->
  <script>
    // Manejo de formulario del lado cliente
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector("form");
      const submitButton = form?.querySelector(
        'button[type="submit"]'
      ) as HTMLButtonElement;

      if (form && submitButton) {
        form.addEventListener("submit", (e) => {
          // Mostrar estado de carga
          submitButton.disabled = true;
          submitButton.textContent = "Iniciando sesi√≥n...";

          // Validaci√≥n b√°sica
          const email = form.querySelector(
            'input[name="email"]'
          ) as HTMLInputElement;
          const password = form.querySelector(
            'input[name="password"]'
          ) as HTMLInputElement;

          if (!email.value || !password.value) {
            e.preventDefault();
            alert("Por favor, completa todos los campos");
            submitButton.disabled = false;
            submitButton.textContent = "Iniciar sesi√≥n";
            return;
          }

          if (password.value.length < 8) {
            e.preventDefault();
            alert("La contrase√±a debe tener al menos 8 caracteres");
            submitButton.disabled = false;
            submitButton.textContent = "Iniciar sesi√≥n";
            return;
          }
        });
      }
    });
  </script>
</AuthLayout>
